---
# yaml-language-server: $schema=https://crd.movishell.pl/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app nextcloud
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.7.1
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  maxHistory: 2
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  dependsOn:
    - name: democratic-csi-nfs
      namespace: storage
    - name: democratic-csi-iscsi
      namespace: storage
  values:
    defaultPodOptions:
      annotations:
        reloader.stakater.com/auto: "true"
        secret.reloader.stakater.com/reload: *app
      securityContext:
        runAsUser: &uid 5000
        runAsGroup: *uid
        fsGroup: *uid
    controllers:
      nextcloud:
        replicas: 1
        strategy: RollingUpdate
        annotations:
          reloader.stakater.com/auto: "true"
        containers:
          nextcloud:
            image:
              repository: docker.io/library/nextcloud
              tag: 30.0.5-fpm-alpine
            env:
              - name: TZ
                value: "${CONFIG_TIMEZONE}"
              - name: ADMIN_USER
                valueFrom:
                  secretKeyRef:
                    name: *app
                    key: NEXTCLOUD_ADMIN_USER
              - name: ADMIN_PASSWORD
                valueFrom:
                  secretKeyRef:
                    name: *app
                    key: NEXTCLOUD_ADMIN_PASSWORD
              - name: SMTP_HOST
                valueFrom:
                  secretKeyRef:
                    name: *app
                    key: SMTP_HOST
              - name: SMTP_PORT
                value: "465"
              - name: SMTP_USERNAME
                valueFrom:
                  secretKeyRef:
                    name: *app
                    key: SMTP_USERNAME
              - name: SMTP_PASSWORD
                valueFrom:
                  secretKeyRef:
                    name: *app
                    key: SMTP_PASSWORD
              - name: MAIL_FROM_ADDRESS
                value: "nextcloud"
              - name: MAIL_DOMAIN
                value: "${SECRET_DOMAIN}"
              - name: POSTGRES_HOST
                valueFrom:
                  secretKeyRef:
                    name: *app
                    key: POSTGRES_HOST
              - name: POSTGRES_USER
                valueFrom:
                  secretKeyRef:
                    name: *app
                    key: POSTGRES_USER
              - name: POSTGRES_DB
                valueFrom:
                  secretKeyRef:
                    name: *app
                    key: POSTGRES_DB
              - name: POSTGRES_PASSWORD
                valueFrom:
                  secretKeyRef:
                    name: *app
                    key: POSTGRES_PASSWORD
              - name: REDIS_HOST
                value: dragonfly.database.svc.cluster.local
              - name: REDIS_HOST_PORT
                value: "6379"
              - name: REDIS_HOST_PASSWORD
                valueFrom:
                  secretKeyRef:
                    name: *app
                    key: REDIS_HOST_PASSWORD
              - name: NEXTCLOUD_DATA_DIR
                value: /data
          nginx:
            image:
              repository: nginxinc/nginx-unprivileged
              tag: 1.27-alpine
          # collabora:
          #   image:
          #     repository: collabora/code
          #     tag: 24.04.12.2.1@sha256:46f799f6f5d4b985dbfdaacabbdcb6ecb90c4e3659d28a4b66757f6946c07829
          #   env:
          #     - name: username
          #       valueFrom:
          #         secretKeyRef:
          #           name: *app
          #           key: COLLABORA_USERNAME
          #     - name: password
          #       valueFrom:
          #         secretKeyRef:
          #           name: *app
          #           key: COLLABORA_PASSWORD
          #     - name: extra_params
          #       value: "--o:ssl.termination=true --o:ssl.enable=false --o:welcome.enable=false --o:net.frame_ancestors=nextcloud.${SECRET_DOMAIN}"
          #     - name: dictionaries
          #       value: "de_DE en_GB en_US es_ES fr_FR"
          #     - name: server_name
          #       value: "nextcloud.${SECRET_DOMAIN}"
          #   securityContext:
          #     runAsUser: 100
          #     runAsGroup: 101
          #     fsGroup: *uid
          # whiteboard:
          #   image:
          #     repository: ghcr.io/nextcloud-releases/whiteboard
          #     tag: v1.0.5
          #   env:
          #     - name: NEXTCLOUD_URL
          #       value: "nextcloud.${SECRET_DOMAIN}"
          #     - name: JWT_SECRET_KEY
          #       valueFrom:
          #         secretKeyRef:
          #           name: *app
          #           key: WHITEBOARD_JWT_SECRET_KEY
          #     - name: STORAGE_STRATEGY
          #       value: "redis"
          #     - name: REDIS_URL
          #       value: "redis://:${REDIS_HOST_PASSWORD}@dragonfly.database.svc.cluster.local:6379/6"
          #   securityContext:
          #     runAsUser: &uidNobody 65534
          #     runAsGroup: *uidNobody
          #     fsGroup: *uidNobody
        # initContainers:
        #   init-chmod-pvc:
        #     image:
        #       repository: docker.io/library/alpine
        #       tag: 3.21.2
        #     command: ["/bin/sh"]
        #     args: ["-c", "mkdir -p /var/www/html/config && chmod 0770 /var/www/html/config && chown 5000:5000 /var/www/html/config && mkdir -p /usr/local/etc/php/conf.d && chmod 0770 /usr/local/etc/php/conf.d && chown 5000:5000 /usr/local/etc/php/conf.d"]
        #     securityContext:
        #       runAsUser: 0
        #       runAsGroup: 0
    service:
      nginx:
        controller: *app
        ports:
          http:
            port: 8080
      # collabora:
      #   controller: *app
      #   ports:
      #     http:
      #       port: 9980
      # whiteboard:
      #   controller: *app
      #   ports:
      #     http:
      #       port: 3002
    ingress:
      nextcloud:
        className: internal
        annotations:
          nginx.ingress.kubernetes.io/proxy-body-size: "10G"
          nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
          nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
        hosts:
          - host: &host "{{ .Release.Name }}.${SECRET_DOMAIN}"
            paths:
              - path: /
                service:
                  identifier: nginx
                  port: http
        tls:
          - hosts:
              - *host
    persistence:
      config:
        existingClaim: nextcloud-config
        advancedMounts:
          nextcloud:
            # init-chmod-pvc:
            #   - path: /var/www/html
            #     subPath: config
            #     readOnly: false
            nextcloud:
              - path: /var/www/html
                subPath: config
                readOnly: false
            nginx:
              - path: /var/www/html
                subPath: config
                readOnly: true
      data:
        existingClaim: nextcloud-data
        advancedMounts:
          nextcloud:
            data:
              - path: /data
                subPath: data
                readOnly: false
      # collabora:
      #   existingClaim: collabora
      #   advancedMounts:
      #     nextcloud:
      #       collabora:
      #         - path: /var/cache/coolwsd
      #           subPath: coolwsd
      #           readOnly: false
      #         - path: /opt/cool
      #           subPath: cool
      #           readOnly: false
      app-config:
        type: configMap
        name: nextcloud-app-config
        globalMounts:
          - path: /var/www/html/config/extra.config.php
            subPath: extra.config.php
            readOnly: true
          - path: /usr/local/etc/php/conf.d/opcache-recommended.ini
            subPath: opcache-recommended.ini
            readOnly: true
          - path: /usr/local/etc/php/conf.d/redis-session.ini
            subPath: redis-session.ini
            readOnly: true
          - path: /usr/local/etc/php/conf.d/uploadLimit.ini
            subPath: uploadLimit.ini
            readOnly: true
          - path: /usr/local/etc/php-fpm.d/www.conf
            subPath: www.conf
            readOnly: true
      nginx-config:
        type: configMap
        name: nextcloud-nginx-config
        globalMounts:
          - path: /etc/nginx/nginx.conf
            subPath: nginx.conf
            readOnly: true
